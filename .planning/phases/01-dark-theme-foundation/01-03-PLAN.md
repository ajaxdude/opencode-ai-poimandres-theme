---
phase: 01-dark-theme-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - scripts/validate-contrast.ts
  - .planning/phases/01-dark-theme-foundation/contrast-report.md
  - .planning/phases/01-dark-theme-foundation/syntax-validation.md
autonomous: false
must_haves:
  truths:
    - "All text/background color pairs meet WCAG AA (4.5:1 for normal text)"
    - "All UI element pairs meet WCAG AA (3:1 for large text/icons)"
    - "Contrast report lists all tested pairs with pass/fail status"
    - "Any failing pairs documented with specific ratios and requirements"
    - "Report includes recommendations for fixing failures (if any)"
    - "Syntax highlighting documented for multiple languages (JS, TS, Python, HTML, CSS, JSON)"
  artifacts:
    - path: "scripts/validate-contrast.ts"
      provides: "WCAG AA contrast validation for theme files"
      min_lines: 80
    - path: ".planning/phases/01-dark-theme-foundation/contrast-report.md"
      provides: "Detailed contrast validation results"
      min_lines: 50
    - path: ".planning/phases/01-dark-theme-foundation/syntax-validation.md"
      provides: "Syntax highlighting test cases and token mappings"
      min_lines: 80
  key_links:
    - from: "scripts/validate-contrast.ts"
      to: ".opencode/themes/poimandres-turquoise-expanded.json"
      via: "reads and validates"
      pattern: "poimandres-turquoise-expanded.json|turquoise-expanded"
    - from: "scripts/validate-contrast.ts"
      to: ".opencode/themes/poimandres.json"
      via: "compares with original"
      pattern: "poimandres\\.json"
---

<objective>
Validate WCAG AA compliance for all color pairs in turquoise-expanded variant

Purpose: Ensure theme variant meets accessibility standards (4.5:1 for normal text, 3:1 for large text/icons)
Output: Contrast validation script and detailed report with pass/fail results
</objective>

<execution_context>
@/home/papa/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/papa/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.opencode/themes/poimandres.json
@.opencode/themes/poimandres-turquoise-expanded.json
@.planning/phases/01-dark-theme-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WCAG AA contrast validation script</name>
  <files>scripts/validate-contrast.ts</files>
  <action>
Create TypeScript script that validates WCAG AA compliance for theme color pairs:

1. **WCAG Contrast Calculation:**
   Implement the WCAG 2.2 contrast ratio formula:
   - Calculate relative luminance for each color (from RGB)
   - L = 0.2126 * R + 0.7152 * G + 0.0722 * B (after gamma correction)
   - Contrast ratio = (L1 + 0.05) / (L2 + 0.05) where L1 is lighter color
   - Required ratios:
     - Normal text: 4.5:1 (WCAG AA)
     - Large text (18pt+ or 14pt+ bold): 3:1 (WCAG AA)
     - UI components (icons, borders): 3:1 (WCAG AA)

2. **Color Pair Validation List:**
   Validate these critical pairs from the theme:

   **Text on Background (dark mode):**
   - primary.dark + background.dark
   - secondary.dark + background.dark
   - accent.dark + background.dark
   - text.dark + background.dark
   - textMuted.dark + background.dark

   **Text on Background (light mode):**
   - primary.light + background.light
   - secondary.light + background.light
   - accent.light + background.light
   - text.light + background.light
   - textMuted.light + background.light

   **Text on Panel (dark mode):**
   - text.dark + backgroundPanel.dark
   - textMuted.dark + backgroundPanel.dark
   - error.dark + backgroundPanel.dark
   - warning.dark + backgroundPanel.dark

   **Text on Panel (light mode):**
   - text.light + backgroundPanel.light
   - textMuted.light + backgroundPanel.light
   - error.light + backgroundPanel.light
   - warning.light + backgroundPanel.light

   **UI Elements:**
   - border.dark + background.dark
   - borderActive.dark + background.dark
   - inputCursor.dark + inputBackground.dark

3. **Implementation Details:**
   - Read theme file from command line argument or stdin
   - Parse JSON structure
   - Extract hex values for each color reference
   - Calculate contrast ratios for each pair
   - Compare against WCAG AA requirements
   - Generate detailed report

4. **Output Format:**
   ```
   WCAG AA Contrast Validation Report
   =================================

   Theme: poimandres-turquoise-expanded.json

   Dark Mode Validation
   -------------------
   ✓ primary.dark on background.dark: 7.2:1 (required 4.5:1)
   ✓ text.dark on background.dark: 7.2:1 (required 4.5:1)
   ✓ textMuted.dark on background.dark: 4.7:1 (required 4.5:1)
   ✓ error.dark on backgroundPanel.dark: 5.1:1 (required 3:1)
   ⚠  border.dark on background.dark: 2.8:1 (required 3:1) - FAIL

   Light Mode Validation
   ---------------------
   ✓ text.light on background.light: 12.5:1 (required 4.5:1)
   ...

   Summary
   -------
   Total pairs tested: 25
   Passed: 24
   Failed: 1
   WCAG AA compliance: 96%

   Failing Pairs
   -------------
   - border.dark (#506477) on background.dark (#1b1e28): 2.8:1 < 3:1
     Recommendation: Increase border darkness or use lighter background

   Exit code: 1 (failures detected)
   ```

5. **Exit Codes:**
   - 0: All pairs pass WCAG AA
   - 1: At least one pair fails WCAG AA
   - 2: Invalid input or error

6. **Usage:**
   ```bash
   # Validate specific theme file
   node scripts/validate-contrast.ts .opencode/themes/poimandres-turquoise-expanded.json

   # Compare with original theme
   node scripts/validate-contrast.ts .opencode/themes/poimandres.json
   ```

DO NOT use external contrast libraries - implement WCAG formula natively.
  </action>
  <verify>
  ```bash
  # Run on original theme (should pass)
  node scripts/validate-contrast.ts .opencode/themes/poimandres.json
  echo "Exit code: $?"

  # Run on variant theme
  node scripts/validate-contrast.ts .opencode/themes/poimandres-turquoise-expanded.json
  echo "Exit code: $?"

  # Verify output format contains expected sections
  node scripts/validate-contrast.ts .opencode/themes/poimandres.json | grep -q "WCAG AA Contrast Validation Report"
  node scripts/validate-contrast.ts .opencode/themes/poimandres.json | grep -q "Summary"
  node scripts/validate-contrast.ts .opencode/themes/poimandres.json | grep -q "Passed:"
  ```
  </verify>
  <done>
  - Script calculates WCAG contrast ratios correctly
  - Validates all critical color pairs
  - Produces detailed report with pass/fail status
  - Includes recommendations for failing pairs
  - Exit code reflects validation result
  - Works with any valid theme JSON file
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and save contrast report</name>
  <files>.planning/phases/01-dark-theme-foundation/contrast-report.md</files>
  <action>
Generate and save the contrast validation report:

1. **Run Validation:**
   Execute contrast validation on both theme files:
   ```bash
   node scripts/validate-contrast.ts .opencode/themes/poimandres-turquoise-expanded.json > .planning/phases/01-dark-theme-foundation/contrast-report.md
   ```

2. **Create Report Document:**
   Write the complete validation output to a markdown file that includes:
   - Validation date and timestamp
   - Theme file validated
   - Complete pair-by-pair results
   - Summary statistics
   - Any failing pairs with specific ratios and recommendations
   - Comparison with original theme (if available)

3. **Report Structure:**
   ```markdown
   # WCAG AA Contrast Validation Report

   **Date:** 2026-02-10
   **Theme:** poimandres-turquoise-expanded.json

   ## Dark Mode Validation

   ### Text on Background
   - primary.dark (#00CED1) on background.dark (#1b1e28): **7.2:1** ✓ (required 4.5:1)
   - text.dark (#a6accd) on background.dark (#1b1e28): **7.2:1** ✓ (required 4.5:1)
   - ...

   ### Text on Panel
   - ...

   ### UI Elements
   - ...

   ## Light Mode Validation

   ...

   ## Summary

   | Metric | Value |
   |--------|--------|
   | Total pairs tested | 25 |
   | Passed | 24 |
   | Failed | 1 |
   | WCAG AA compliance | 96% |

   ## Failing Pairs

   None - All pairs pass WCAG AA requirements ✅

   ## Comparison with Original Theme

   Original theme compliance: 100% (25/25 pairs)
   New variant compliance: 96% (24/25 pairs)
   Change: -4% due to expanded turquoise palette adjustments

   ---

   *Generated by scripts/validate-contrast.ts*
   ```
  </action>
  <verify>
  ```bash
  # Verify report file exists
  test -f .planning/phases/01-dark-theme-foundation/contrast-report.md && echo "Report exists" || echo "Report missing"

  # Verify report contains required sections
  grep -q "WCAG AA Contrast Validation Report" .planning/phases/01-dark-theme-foundation/contrast-report.md
  grep -q "Summary" .planning/phases/01-dark-theme-foundation/contrast-report.md
  grep -q "## Dark Mode" .planning/phases/01-dark-theme-foundation/contrast-report.md
  grep -q "## Light Mode" .planning/phases/01-dark-theme-foundation/contrast-report.md

  # Verify report has content
  wc -l .planning/phases/01-dark-theme-foundation/contrast-report.md
  ```
  </verify>
  <done>
  - Contrast report generated and saved
  - Report includes dark mode validation results
  - Report includes light mode validation results
  - Report includes summary with pass/fail statistics
  - Any failing pairs documented with recommendations
  - Report is valid markdown format
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate syntax highlighting across multiple languages</name>
  <files>.planning/phases/01-dark-theme-foundation/syntax-validation.md</files>
  <action>
  Validate that syntax highlighting works correctly for common programming languages:

  1. **Create Sample Code Files:**
     Create test code samples for these languages:
     - JavaScript (ES6+ syntax)
     - TypeScript (types, interfaces, generics)
     - Python (decorators, type hints)
     - HTML (tags, attributes)
     - CSS (selectors, properties)
     - JSON (objects, arrays)

  2. **Syntax Token Coverage Check:**
     Verify each language sample exercises all syntax token categories from theme:
     - Comments: Single-line, multi-line
     - Keywords: const/let/var, if/else, return, import/export, class, function
     - Strings: Single quotes, double quotes, template literals
     - Numbers: Integers, floats, negative
     - Types: Interface definitions, type annotations, generics
     - Functions: Function declarations, arrow functions, method calls
     - Variables: var/let/const declarations, property access
     - Constants: Upper-case constants, enum values

  3. **Visual Validation Report:**
     Create a markdown report documenting:
     ```markdown
     # Syntax Highlighting Validation Report

     **Date:** 2026-02-10
     **Theme:** poimandres-turquoise-expanded.json

     ## Token Coverage by Language

     ### JavaScript
     - ✓ Comments (//, /**/)
     - ✓ Keywords (const, function, return, if, else)
     - ✓ Strings ('...', "...", \`...\`)
     - ✓ Numbers (0, 1.5, -10)
     - Functions (myFunc(), arrow functions)
     - Variables (const x = ...)
     - Errors/Warnings (throw, console.error)

     ### TypeScript
     - ✓ Comments (JSDoc, inline)
     - ✓ Keywords (interface, type, extends, implements)
     - ✓ Strings (all types)
     - ✓ Types (MyInterface, Generic<T>, string | number)
     - ✓ Functions (method signatures)
     - ✓ Variables (type annotations)

     ### Python
     - ✓ Comments (#, '''...''')
     - ✓ Keywords (def, class, if, else, return, import)
     - ✓ Strings (', ", '''...''')
     - ✓ Numbers (int, float)
     - ✓ Functions (def my_func():)
     - ✓ Decorators (@decorator)
     - ✓ Type hints (x: int -> None)

     ### HTML
     - ✓ Tags (<div>, <span>, etc.)
     - ✓ Attributes (class, id, href)
     - ✓ Strings (attribute values)
     - ✓ Comments (<!-- ... -->)

     ### CSS
     - ✓ Selectors (.class, #id, element)
     - ✓ Properties (color, background)
     - ✓ Values (hex, rgb(), keywords)
     - ✓ Comments (/* ... */)

     ### JSON
     - ✓ Keys (property names)
     - ✓ String values
     - ✓ Numbers
     - ✓ Booleans (true, false)
     - ✓ Null values

     ## Token Color Mapping Verification

     | Token Category | Theme Color | Expected Hex |
     |---------------|--------------|---------------|
     | Comments | textMuted | #767c9d |
     | Keywords | syntaxKeyword | #91B4D5 |
     | Strings | syntaxString | #00CED1 |
     | Numbers | syntaxNumber | #91B4D5 |
     | Types | syntaxType | #ADD7FF |
     | Functions | syntaxFunction | #5DE4c7 |
     | Variables | syntaxVariable | #00CED1 |
     | Constants | syntaxConstant | #00CED1 |
     | Errors | error | #d0679d |

     ## Summary

     - ✓ All languages tested
     - ✓ All token categories exercised
     - ✓ Color mappings verified against theme defs
     - ✓ No syntax highlighting errors detected
     ```

  4. **Validation Method:**
     - This is a documentation task - actual visual testing requires an editor/IDE
     - The report documents what SHOULD be tested and expected color mappings
     - Human will verify visually during execution phase or in Phase 2 when integrated
   </action>
  <verify>
  ```bash
  # Verify report exists and contains all sections
  test -f .planning/phases/01-dark-theme-foundation/syntax-validation.md && echo "Report exists"

  grep -q "# Syntax Highlighting Validation Report" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "### JavaScript" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "### TypeScript" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "### Python" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "### HTML" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "### CSS" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "### JSON" .planning/phases/01-dark-theme-foundation/syntax-validation.md
  grep -q "## Token Color Mapping Verification" .planning/phases/01-dark-theme-foundation/syntax-validation.md

  echo "All sections verified"
  ```
  </verify>
  <done>
  - Syntax validation report created
  - Report documents test cases for 6 languages
  - Report verifies all syntax token categories
  - Report includes expected color mappings
  - Token coverage documented for Comments, Keywords, Strings, Numbers, Types, Functions, Variables, Constants
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of contrast compliance</name>
  <files></files>
  <action>
Human verification step - requires manual review and approval
  </action>
  <verify>
Human manually reviews contrast report
  </verify>
  <done>
Human approves or requests changes to contrast compliance
  </done>
  <what-built>Complete WCAG AA contrast validation system with detailed report</what-built>
  <how-to-verify>
    1. Review the contrast report at `.planning/phases/01-dark-theme-foundation/contrast-report.md`
    2. Check that all critical color pairs meet WCAG AA requirements
    3. Note any failing pairs and their contrast ratios
    4. Review recommendations for fixing failures (if any)
    5. Confirm whether the accessibility compliance is acceptable for Phase 1

    Expected outcome:
    - All text/background pairs meet or exceed 4.5:1 contrast
    - All UI elements meet or exceed 3:1 contrast
    - If failures exist, they are documented with actionable fixes
    - Report provides clear pass/fail status for each pair

    If failures exist and are unacceptable:
    - The plan will need to address specific color adjustments
    - You may request changes to the turquoise palette
    - You may accept the failures if they meet minimum practical requirements
  </how-to-verify>
  <resume-signal>Type "approved" if contrast compliance is acceptable, or describe which failures need to be fixed</resume-signal>
</task>

</tasks>

<verification>
1. Execute contrast validation script on variant theme
2. Execute contrast validation script on original theme (for comparison)
3. Verify script produces correct contrast ratios
4. Generate and save contrast report
5. Create syntax highlighting validation report with language test cases
6. Verify syntax token mappings documented for all token categories
7. Human reviews reports and approves
</verification>

<success_criteria>
- WCAG contrast validation script created and working
- Validation executed on turquoise-expanded variant
- Contrast report generated with all test results
- All text/background pairs meet 4.5:1 requirement (or documented failures)
- All UI element pairs meet 3:1 requirement (or documented failures)
- Contrast report saved to phase directory
- Syntax highlighting validation report created with 6 languages covered
- All syntax token categories documented with expected color mappings
- Human approval received for compliance level
</success_criteria>

<output>
After completion, create `.planning/phases/01-dark-theme-foundation/01-03-SUMMARY.md`
</output>
