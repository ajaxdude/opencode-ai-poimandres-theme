---
wave: 4
autonomous: true
gap_closure: true
depends_on:
  - 01-02
  - 01-03
---

# 01-04: Create WCAG AA Compliant Variant

## Objective

Create a new theme variant `poimandres-accessible.json` that fixes all 12 failing color pairs from the original theme to achieve 100% WCAG AA compliance while preserving Poimandres aesthetic as much as possible.

## Context

From the contrast validation report (01-03):
- **Current compliance**: 50% (12/24 pairs pass)
- **Failing pairs**: 12 total
  - 4 dark mode: textMuted, error, border, warning on panel/background
  - 9 light mode: primary, secondary, accent, text on background/panel

The failing pairs need color adjustments while maintaining visual hierarchy and Poimandres character.

## Tasks

### Task 1: Analyze color adjustment strategy

**What**: Determine optimal color adjustments for each failing pair

**Approach**:
1. For each failing pair, identify adjustment direction:
   - Make text darker (lower luminance) or background lighter (higher luminance)
   - Preserve hue and saturation where possible to maintain aesthetic
   - Target: 4.5:1 minimum for normal text, 3:1 for large text

2. Create mapping document `.planning/phases/01-dark-theme-foundation/color-adjustments.md` with:
   - Original color (hex, HSL)
   - Recommended adjustment (direction, magnitude)
   - New color proposal (hex, HSL)
   - Expected contrast ratio

**Files**:
- `.planning/phases/01-dark-theme-foundation/color-adjustments.md`

**Commit message**: `feat: document color adjustment strategy for WCAG compliance`

**Verification**:
- [ ] All 12 failing pairs have documented adjustment proposals
- [ ] Each proposal includes original color, adjustment strategy, and new color
- [ ] Expected contrast ratios meet WCAG AA thresholds

---

### Task 2: Implement color adjustments in new variant

**What**: Create `poimandres-accessible.json` with adjusted colors

**Approach**:
1. Start from `poimandres-turquoise-expanded.json` as base
2. Apply color adjustments from Task 1:
   - **Dark mode adjustments**:
     - textMuted: Increase contrast to 4.5:1
     - error: Increase contrast to 4.5:1 (or 3:1 for large text)
     - border: Increase contrast to 3:1 (UI element)
     - warning: Increase contrast to 3:1 (UI element)
   - **Light mode adjustments**:
     - primary: Increase contrast to 4.5:1
     - secondary: Increase contrast to 4.5:1
     - accent: Increase contrast to 4.5:1 (or 3:1 for decorative)
     - text: Ensure 4.5:1 on both background and panel

3. Adjust colors minimally while preserving aesthetic:
   - Prefer adjusting text colors darker over backgrounds lighter
   - For UI elements (border, warning), 3:1 is acceptable
   - Maintain relative color hierarchy within each category

4. Validate all colors remain within reasonable HSL ranges:
   - Saturation: 60-100% (avoid washed out or neon)
   - Lightness: 5-95% (avoid pure black/white)
   - Hue: ±10° from original (preserve color character)

**Files**:
- `theme/poimandres-accessible.json`

**Commit message**: `feat: create WCAG AA compliant theme variant`

**Verification**:
- [ ] All 24 color pairs meet WCAG AA minimums
- [ ] Colors maintain Poimandres aesthetic (saturation, lightness, hue ranges)
- [ ] Relative color hierarchy preserved (darker to lighter within categories)
- [ ] Variant follows poimandres.json structure

---

### Task 3: Validate 100% WCAG AA compliance

**What**: Verify all 24 color pairs pass WCAG AA

**Approach**:
1. Run contrast validation script on new variant:
   ```bash
   node --loader ts-node/esm scripts/validate-contrast.ts theme/poimandres-accessible.json
   ```

2. Generate new contrast report:
   ```bash
   node --loader ts-node/esm scripts/validate-contrast.ts \
     --output .planning/phases/01-dark-theme-foundation/contrast-report-accessible.md \
     theme/poimandres-accessible.json
   ```

3. Verify 100% compliance:
   - All 24 pairs must pass (4.5:1 for text, 3:1 for UI)
   - Report must show 0 failures

4. Create comparison document:
   ```bash
   cat > .planning/phases/01-dark-theme-foundation/variant-comparison.md << 'EOF'
   # Variant Comparison: Compliance vs Aesthetic

   | Variant | Compliance | Color Adjustments | Aesthetic Preservation |
   |---------|-----------|-------------------|----------------------|
   | turquoise-expanded | 50% | 0 (original) | 100% |
   | accessible | 100% | 12 pairs | TBD% |
   EOF
   ```

**Files**:
- `.planning/phases/01-dark-theme-foundation/contrast-report-accessible.md`
- `.planning/phases/01-dark-theme-foundation/variant-comparison.md`

**Commit message**: `test: validate WCAG AA compliance for accessible variant`

**Verification**:
- [ ] All 24 color pairs pass WCAG AA
- [ ] Contrast report shows 0 failures
- [ ] Comparison document created
- [ ] Exit code 0 from validation script

---

### Task 4: Document color changes and trade-offs

**What**: Create comprehensive documentation of accessibility improvements

**Approach**:
1. Create color change summary table:
   - Pair name (e.g., "textMuted on panel")
   - Original contrast ratio
   - New contrast ratio
   - Color change (hex diff, HSL change)
   - Aesthetic impact (minimal, moderate, significant)

2. Add section to comparison document:
   ```markdown
   ## Color Changes Summary

   ### Dark Mode (4 pairs adjusted)

   | Pair | Original | New | Ratio Change | Impact |
   |------|----------|------|--------------|--------|
   | textMuted on panel | 3.9:1 | X:1 | +X.X | Minimal |
   | ...

   ### Light Mode (9 pairs adjusted)

   [Similar table]

   ## Trade-offs

   - [What aesthetic compromises were made]
   - [How visual hierarchy is maintained]
   - [Recommendations for variant selection]
   ```

3. Create README section for variant selection:
   ```markdown
   ## Theme Variants

   ### poimandres-turquoise-expanded
   - **Compliance**: 50% WCAG AA (12/24 pairs)
   - **Aesthetic**: 100% faithful to original
   - **Use when**: Visual fidelity is priority, accessibility acceptable

   ### poimandres-accessible
   - **Compliance**: 100% WCAG AA (24/24 pairs)
   - **Aesthetic**: ~85% faithful (minimal color adjustments)
   - **Use when**: Accessibility is priority
   ```

**Files**:
- `.planning/phases/01-dark-theme-foundation/variant-comparison.md` (updated)
- `.planning/phases/01-dark-theme-foundation/01-04-COLOR-CHANGES.md` (new)

**Commit message**: `docs: document color changes and trade-offs for accessible variant`

**Verification**:
- [ ] All 12 adjusted pairs documented with before/after
- [ ] Aesthetic impact assessed for each change
- [ ] Trade-offs section explains compromises
- [ ] Variant selection guide created

---

## Success Criteria

1. **100% WCAG AA compliance**: All 24 color pairs meet minimum contrast (4.5:1 for text, 3:1 for UI)
2. **Preserved aesthetic**: Color adjustments maintain Poimandres character (saturation 60-100%, hue ±10°, lightness 5-95%)
3. **Comprehensive documentation**: All color changes documented with before/after and impact assessment
4. **Valid variant**: poimandres-accessible.json follows poimandres.json structure and works with OpenCode

## Acceptance Criteria

- [ ] Contrast validation passes (exit code 0, 0 failures)
- [ ] Contrast report shows 24/24 pairs pass
- [ ] Color adjustments documented with HSL changes
- [ ] Aesthetic impact assessed for all 12 adjustments
- [ ] Variant comparison table created
- [ ] README variant selection guide added
